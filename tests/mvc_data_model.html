<!-- Standard Code -->

<html><head>
    
<script type="text/javascript" src="../../ext/adapter/ext/ext-base.js"></script>
<script type="text/javascript" src="../../ext/ext-all-debug.js"></script>
<script type="text/javascript" src="../../jsunit/app/jsUnitCore.js"></script>
<script type="text/javascript" src="jsmock.js"></script>
<script type="text/javascript" src="helpers.js"></script>

<!-- End Standard Code -->

<script type="text/javascript" src="../data_stores.js"></script>
<script type="text/javascript" src="../mvc_data_models.js"></script>
<script type="text/javascript" src="../mvc_crud_controller.js"></script>

</head><body><script type="text/javascript">

function testSaveFormNotValid() {
  var mc = new MockControl();

  var dm = new SWorks.DataModel();
  var form  = mc.createMock(Ext.form.BasicForm);
  form.expects().isValid().andReturn(false);

  var oldMessageBox = Ext.MessageBox;
  Ext.MessageBox = mc.createMock(Ext.MessageBox);
  dm.saveForm(form, { waitMsg: false });

  mc.verify();

  form.expects().isValid().andReturn(false);
  Ext.MessageBox.expects().alert(TypeOf.isA(String), TypeOf.isA(String));

  dm.saveForm(form, {}); // Without waitMsg:false

  mc.verify();

  Ext.MessageBox = oldMessageBox;
}

function testSaveFormValid() {
  var mc = new MockControl();
  var options = {};
  var dm = new SWorks.DataModel({
    recordType: Ext.data.Record.create(['person_type', 'name']),
    restUrl: '/test',
    dealWithEmptyCombos: Ext.emptyFn
  });

  var form  = mc.createMock(Ext.form.BasicForm);
  form.record = { newRecord: false };

  dm.controller = mc.createMock(SWorks.AbstractController);

  form.expects().isValid().andReturn(true);
  form.expects().updateRecord(TypeOf.isA(dm.recordType));
  form.expects().submit(options);

  dm.saveForm(form, options);
  mc.verify();

  form.expects().isValid().andReturn(true);
  // Shouldn't try to save while another save is going
  dm.saveForm(form, options);
  mc.verify();
}

function testSaveFormWithParent() {
  var mc = new MockControl();
  var options = {};
  var dm = new SWorks.DataModel({
    foreignKey: 'person_id',
    parameterTemplate: 'bob[{0}]',
    recordType: Ext.data.Record.create(['person_type', 'name']),
    restUrl: '/test',
    dealWithEmptyCombos: Ext.emptyFn
  });

  var form  = mc.createMock(Ext.form.BasicForm);
  form.record = { newRecord: false };

  dm.controller = mc.createMock(SWorks.AbstractController);
  dm.controller.parentForm = mc.createMock(Ext.form.BasicForm);
  dm.controller.parentForm.record = { id: Ext.id(), data: { klass: 'bob' } };

  form.expects().isValid().andReturn(true);
  form.expects().updateRecord(TypeOf.isA(dm.recordType));
  form.expects().submit(options);

  dm.saveForm(form, options);
  mc.verify();

  form.expects().isValid().andReturn(true);
  // Shouldn't try to save while another save is going
  dm.saveForm(form, options);
  mc.verify();
}

function testLinkToParent() {
  var mc = new MockControl();
  var compt = mc.createMock(SWorks.AbstractController);
  var store = new Ext.data.Store();

  // Persistent filters are required for standard linking to parent
  Ext.ux.data.PersistentFilters(store);

  var dm = new SWorks.StoreDataModel({ store: store });
  var childId = "I'm the child";
  var callback;

  // Don't link if you don't have a foreignKey
  dm.linkToParent(compt, childId);
  mc.verify();

  dm.foreignKey = 'key';
  compt.expects().on('load', TypeOf.isA(Function), dm).andStub(function() {
    callback = arguments[1];
  });

  // execute your callback when the parent loads
  dm.linkToParent(compt, childId);
  mc.verify();

  // when the parent loads, filter the grid
  store.expectsCall('addFilter').withArgs(TypeOf.isA(Function), dm);
  callback.call(dm, { id: childId }, {});
  mc.verify();
}

function testFormSuccess() {
  // Test with a basic form not inited by a controller
  var mc = new MockControl();
  var dm = new SWorks.DataModel({
    foreignKey: 'person_id',
    parameterTemplate: 'bob[{0}]',
    recordType: Ext.data.Record.create(['person_type', 'name']),
    restUrl: '/test',
    dealWithEmptyCombos: Ext.emptyFn
  });

  var form  = new Ext.form.BasicForm();
  var action = { result: {}, options: { dataSentRecord: new dm.recordType() } };

  // new record
  form.record = new dm.recordType();
  form.record.newRecord = true;
  dm.on('save', function() { assert('newBeforeSave', action.newBeforeSave == true); });
  dm.formSuccess(form, action);
  mc.verify();

  // existing record
  form.record = new dm.recordType();
  dm.formSuccess(form, action);
  mc.verify();
}

</script></body></html>
